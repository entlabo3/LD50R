---
title: "Probit analysis"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(MASS)
```

<!-- 
レポートに何か表示させるには，白い背景のところに#(半角空ける)の後に続けて書く
改行する時は1行空行を作る（下記参照）
-->

### Insect Strain Name

### Test Chemical Name & Dose

#### Other comments



```{r, echo=FALSE}
# 手動設定　X軸の範囲と目盛り(対数なので0は指定できない)
x_limit  <- c(2,12) #X軸の軸の範囲
x_labels <- c(2,3,4,5,6,8,10) #表示する目盛

```



```{r, echo=FALSE}
# Initialize

# Functions and datasets to support Venables and Ripley, "Modern Applied Statistics with S" (4th edition, 2002).
# https://cran.r-project.org/web/packages/MASS/index.html

library(MASS)

# ワーキングディレクトリを設定する
#setwd("D:\R\github\LD50R")

```


```{r, echo=FALSE}


filename  <- "data.tsv"

# ファイル名を選択したい場合は，下記を有効にする．
# filename <- file.choose()

cat("Data source file: ", filename)

# データはdose,affected,totalの3列(タブ区切り)で貼り付ける．Excelで作った表をコピペでも可能
# 列名で読み取るので，列名は変更しないこと
raw_data <- read.table(filename, header=T)
raw_data

# コントロール区死亡率の補正（ない場合は無視）
raw_data <- subset(raw_data, dose >= 0) # 濃度が負の場合、削除
sorted_data <- order(raw_data$dose) # 濃度順に並べ替え
raw_data <- raw_data[sorted_data,]  # 濃度順に並べ替え

if (raw_data[1,]$dose == 0) {
  raw_control <- subset(raw_data, dose == 0) # コントロール抽出
  
  control_mortality <- raw_control$affected / raw_control$total #補正死亡率計算
  raw_data <- subset(raw_data, dose > 0) # コントロールを計算とグラフ表示の対象から除外
  rownames(raw_data) <- c(1:nrow(raw_data)) # 行番号付け直し

  # Abottの補正式で補正する（ただし死亡率が負の場合は0とする）
  for (i in (1:nrow(raw_data))) {
    raw_data[i,]$affected <- raw_data[i,]$affected - control_mortality * raw_data[1,]$total
    if (raw_data[i,]$affected < 0) {raw_data[i,]$affected <- 0}
  }
}

raw_dose <- raw_data$dose # 薬量(対数にしない)
affected <- raw_data$affected # 死亡数
total <- raw_data$total # 供試個体数
raw_probit <- qnorm( affected/total )+5 #y <- qnorm( r/n )+5 プロビット変換

```



```{r Graph,echo=FALSE}

dose <- log10(raw_dose) #試験濃度対数への変換
log10x_limit <- log10(x_limit) #X軸範囲対数への変換


baseplot <- function(){

  plot(dose, qnorm(affected/total),
      cex = total/max(total),
      yaxt = "n",
      xaxt = "n",
      xlim=log10x_limit, # X軸の目盛範囲(log10)　薬量に応じて変える
      ylim=c(-2.35, 2.35), # -2.35 < qnorm(0.0094)なので1%-99%の少し外側
      main="Dose-response curve",
      ylab="Mortality rate (%)",
      xlab="Concentration"
  )  
    
  ## 50%ライン
  abline(0, 0, lty = 2, col="skyblue")
  ## 10%ライン
  abline(qnorm(0.1), 0, lty = 2, col="pink") 
  ## 90%ライン
  abline(qnorm(0.9), 0, lty = 2, col="pink")
  
  ## 縦軸probit目盛
  y_labels <- c(1,5,10,25,50,75,90,95,99)
  y_levels <- qnorm(y_labels/100)
  axis(2,at=y_levels,labels=y_labels,cex.axis=0.6)
  
  ## 横軸対数目盛り
    x_levels <- log10(x_labels)
    axis(1,at=x_levels,labels=x_labels,cex.axis=0.6) #cex.axisはフォントの倍率
}

baseplot()

### プロビット法
fit.probit <- glm(cbind(affected, total-affected) ~ dose, family=binomial(probit)) 

## 予測値の計算
x <- data.frame(dose = seq(min(dose), max(dose), diff(range(dose))/1000))

# 回帰直線
d <- dose.p(fit.probit, p = (p <- seq(0.01, 0.99, 0.01)))
lines(d,qnorm(p))

## (rateに対するdoseの)予測値信頼区間(95%)
 dse.pro <- attributes(d)$SE
 p2.lw.pro <- d - dse.pro*1.96
 p2.up.pro <- d + dse.pro*1.96
 lines(p2.lw.pro, qnorm(p), lty = 3)
 lines(p2.up.pro, qnorm(p), lty = 3)
 
```

```{r Tables, echo=FALSE}



# グラフにプロットされている点
cat("Raw data as plotted in graph")
cbind(raw_data,raw_probit)
 
## 値を確認したい死亡率
p=c(0.01,0.05, 0.1,0.2,0.25,0.3,0.4, 0.5,0.6,0.7,0.75,0.8, 0.9, 0.95,0.99)
dp = dose.p(fit.probit, p = p)

LD_values <- attributes(dp)$Dose
  
## 95%信頼限界個別表示
dse.pro <- attributes(dp)$SE
p2.lw.pro <- 10 ^ (dp - dse.pro*1.96) # 1.96は正規分布の5%点
p2.up.pro <- 10 ^ (dp + dse.pro*1.96) 
results <- cbind(10 ^ dp, p2.lw.pro, p2.up.pro)
colnames(results) <- c("LD_Doses","95%CL_Lower", "95%CL_Upper")
cat("LDs and 95% confidential limits")
results

# 回帰式の係数等表示
summary(fit.probit)

```

